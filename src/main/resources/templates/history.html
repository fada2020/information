<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Gentelella Alela!</title>

    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- iCheck -->
	<link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">

    <style>
    	#table1 thead th{
		    text-align:center;
    	}

		#table1 tbody tr{
		    cursor:pointer;
		}

		#exportExcel {
			margin-top:10px;
			background-color:#ff5050;
			float:right;
		}

		.col-md-1{
			margin-left:5%;
		}

		#exportExcel, #searchButton{
			width:80px;
			font-size:14px;
		}

		.pull-right{
			font-size:18px;

		}
	</style>

  </head>
  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
      	<!-- sidebar -->
		<div th:insert="/fragments/sidebar :: sidebar" th:remove="tag"></div>
        <!-- sidebar -->

        <!-- top navigation -->
        <div th:insert="/fragments/top_nav :: top_nav" th:remove="tag"></div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">
          <div class="">
            <div class="page-title">
              <div class="title_left">
                <h3>資産支給履歴</h3>
              </div>
            </div>

            <div class="clearfix"></div>

            <div class="row">
              <div class="col">

				<!-- searching condition -S -->
				<!-- 1st line -->
				<div class="row">

                <div class="col-md-1">
                    <span class="pull-right" style="margin-left:-10%;">管理番号</span>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" placeholder="管理番号" id="assetNumber_search" maxlength="15" >
                </div>


                <div class="col-md-1">
                    <span class="pull-right" style="margin-left:-10%;">貸与日</span>
                </div>
                <div class="col-md-2">
					<fieldset>
						<div class="control-group ">
							<div class="controls">
								<div class="input-prepend input-group">
									<span class="add-on input-group-addon"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span>
									<input type="text" style="width: 200px" name="rental_search" id="rental_search" class="form-control">
								</div>
							</div>
						</div>
					</fieldset>
                </div>

                <div class="col-md-1">
                    <span class="pull-right">状態</span>
                </div>
                <div class="col-md-2">
                	<select class="form-control" id="status_search" style="width:120px;">
						<option value="000">状態</option>
                		<option th:each="code : ${stateCode}" th:value="${code.codeDetailId}"
                		th:inline="text">[[${code.codeDetailName}]]</option>
					</select>
                </div>
				</div>
				<!-- 1st line -->

				<!-- 2nd line -->
				<div class="row" style="height:50px;">

				<div class="col-md-1">
                    <span class="pull-right">貸出者</span>
                </div>
                <div class="col-md-2">
                	<input type="text" class="form-control" placeholder="貸出者" id="applicant_search" maxlength="15">
                </div>


				<div class="col-md-1">
                    <span class="pull-right">返却日</span>
                </div>
                <div class="col-md-2">
					<fieldset>
						<div class="control-group ">
							<div class="controls">
								<div class="input-prepend input-group">
									<span class="add-on input-group-addon"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span>
									<input type="text" style="width: 200px" name="return_search" id="return_search" class="form-control">
								</div>
							</div>
						</div>
					</fieldset>
                </div>

                <div class="col-md-1" style="width:5%; float:right; margin-right:60px;">
                	<button id="searchButton" class="btn btn-primary" >検索</button>
                </div>

                </div>
				<!-- 2nd line -->

				<!-- searching condition -E -->


                <div class="x_panel">

                  <div class="x_title">
                    <button id=exportExcel class="btn btn-primary" title="現在のテーブルをExcelファイルでダウンロード">Excel</button>

                  </div>

                  <div class="x_content">

                    <table class="table table-bordered table-hover table-lg" id="table1" style="width:100%;">
                      <thead class="thead-light">
                      	<tr>
                      		<th colspan="3">装置</th>
                      		<th colspan="9">使用現況</th>
                      	</tr>
                        <tr>
                          <th>管理番号</th>
                          <th>Maker</th>
                          <th>Model</th>

                          <th>状態</th>
                          <th>貸与番号</th>
                          <th>用途</th>
                          <th>場所(Site名)</th>
                          <th>貸出者</th>
                          <th>使用者</th>
                          <th>BP社名</th>
                          <th>貸与日</th>
                          <th>返却日</th>
                        </tr>
                      </thead>
                      <tbody>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- /page content -->

        <!-- footer content -->
        <div th:insert="/fragments/footer :: footer" th:remove="tag"></div>
        <!-- /footer content -->
      </div>
    </div>

    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>

	<!-- jquery-ui -->
	<script th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>
	<!-- DataTable -->
	<script th:src="@{/DataTables-1.10.20/js/jquery.dataTables.min.js}"></script>
	<script th:src="@{/DataTables-1.10.20/js/dataTables.bootstrap4.min.js}"></script>

    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- bootstrap-daterangepicker -->
    <script src="../vendors/moment/min/moment.min.js"></script>
    <script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>

    <!-- page script -->
    <script th:inline="javascript">

    /*<![CDATA[*/

        var modalesectiondata = null;

    	var stateCodeMap = new Map();
    	var stateCode = /*[[${stateCode}]]*/;
    	stateCode.forEach(function( value ) {
    		stateCodeMap.set(value.codeDetailId, value.codeDetailName);
    	});


        $(function(){

			$('#rental_search').daterangepicker({
				startDate: moment().add(0, "months"),
				endDate: moment(),
			 locale: {
			       format: 'YYYY/MM/DD'
			   }, function(start, end, label) {
			       console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
			   }
			});

			$('#return_search').daterangepicker({
				startDate: moment().add(0, "months"),
				endDate: moment(),
			 locale: {
			       format: 'YYYY/MM/DD'
			   }, function(start, end, label) {
			       console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
			   }
			});

            // datatableの設定を変更
            var modalesectiontable = $("#table1").DataTable({
            	"language": {
            		"info":           "表示 _START_ ~ _END_ の _TOTAL_ エントリ",
            		"infoEmpty":      "表示 0 ~ 0 の 0 エントリ",
            	    "infoFiltered":   "",
            	    "paginate": {
            	        "first":      "最初",
            	        "last":       "最後",
            	        "next":       "次へ",
            	        "previous":   "前の"
            	    }
                },
            	"fixedHeader": true,
            	"processing": true,
            	"serverSide": true,
                "searching": false,
                "paging": true,
                "lengthChange": false,
                "ordering": false,
                "ajax": {
                	url: /*[[@{/history/getHistorylist}]]*/ 'History/getHistorylist',
                	type: "POST",
                	dataType: "json",
                	contentType: 'application/JSON',
                	data: function ( d ) {
                		d.columns[0].search.value = $('#assetNumber_search').val();
                		d.columns[1].search.value = $('#applicant_search').val();
                		d.columns[2].search.value = $('#status_search').val();
                		d.columns[3].search.value = $('#rental_search').val();
                		d.columns[4].search.value = $('#return_search').val();

                        return JSON.stringify(d);
                    }
                },
                "columnDefs": [
                    { targets: 0, data: "assetNumber"},
                    { targets: 1, data: "makerName"},
                    { targets: 2, data: "modelName"},
                    { targets: 3, data: function ( d ) {
                    	return stateCodeMap.get(d.statusCode);
                    }},
                    { targets: 4, data: "rentalNo"},
                    { targets: 5, data: "purpose"},
                    { targets: 6, data: "storageLocation"},
                    { targets: 7, data: "applicantId"},
                    { targets: 8, data: "rentalUserId"},
                    { targets: 9, data: "bpName"},
                    { targets: 10, data: function ( d ) {
                    	var str = d.rentalDayS;
                    	return str.substring(0, 4) + "-" + str.substring(4, 6) + "-" + str.substring(6, 8);
                    }},
                    { targets: 11, data: function ( d ) {
                    	var str = d.returnDayS;
                    	return str.substring(0, 4) + "-" + str.substring(4, 6) + "-" + str.substring(6, 8);
                    }}
                ]
            });

            //Search -S
            $('#searchButton').on( 'click', function () {
            	modalesectiontable.column(0).search( this.value ).draw();
            } );
          	//Search -E

          	//table Exportion -S

          	$('#exportExcel').on( 'click', function () {

        		var tab_text = '<html xmlns:x="urn:schemas-microsoft-com:office:excel">';
        		tab_text = tab_text + '<head><meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">';
        		tab_text = tab_text + '<xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>'
        		tab_text = tab_text + '<x:Name>Test Sheet</x:Name>';
        		tab_text = tab_text + '<x:WorksheetOptions><x:Panes></x:Panes></x:WorksheetOptions></x:ExcelWorksheet>';
        		tab_text = tab_text + '</x:ExcelWorksheets></x:ExcelWorkbook></xml></head><body>';
        		tab_text = tab_text + "<table border='1px'>";

        		var exportTable = $('#table1').clone();
        		exportTable.find('input').each(function (index, elem) { $(elem).remove(); });
        		tab_text = tab_text + exportTable.html();
        		tab_text = tab_text + '</table></body></html>';
        		var data_type = 'data:application/vnd.ms-excel';
        		var ua = window.navigator.userAgent;
        		var msie = ua.indexOf("MSIE ");
        		var fileName = 'rentalHistory.xls';

        		//adapt IE
        		if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./)) {
        		if (window.navigator.msSaveBlob) {
        		var blob = new Blob([tab_text], {
        		type: "application/csv;charset=utf-8;"
        		});
        		navigator.msSaveBlob(blob, fileName);
        		}
        		} else {
        		var blob2 = new Blob([tab_text], {
        		type: "application/csv;charset=utf-8;"
        		});
        		var filename = fileName;
        		var elem = window.document.createElement('a');
        		elem.href = window.URL.createObjectURL(blob2);
        		elem.download = filename;
        		document.body.appendChild(elem);
        		elem.click();
        		document.body.removeChild(elem);
        		}
            } );

          	//table Exportion -E

        })



    </script>

</body>
</html>