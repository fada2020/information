<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- Meta, title, CSS, favicons, etc. -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>IT資産管理</title>
<!-- favicons -->
<link rel="icon" href="../images/aisRogo.png">
<!-- Bootstrap -->
<link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<!-- NProgress -->
<link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
<!-- iCheck -->
<link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
<!-- bootstrap-daterangepicker -->
<link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
<!-- bootstrap-datetimepicker -->
<link href="../vendors/bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.css"
	rel="stylesheet">
<!-- Custom Theme Style -->
<link href="../build/css/custom.min.css" rel="stylesheet">
<style>
	#table1 thead, th {text-align: center;}
	#table1 th {vertical-align: middle;}
	#table1 td {vertical-align: middle;}
	.my-custom-scrollbar {
		position: relative;
		height: 130px;
		overflow: auto;
	}
	.table-wrapper-scroll-y {
		display: block;
	}
	.error {
		color: red;
		background-color: lavender;
	}
	.flat {
		display: inline-block;
		width: 18px;
		height: 18px;
		border: 2px solid #bcbcbc;
		cursor: pointer;
	}
	.control-label {
		text-align: center;

	}
	text{
		text-overflow : ellipsis;
	}
.daterangepicker {
    font-size: 11px;

}
</style>
</head>
<body class="nav-md">
	<div class="container body">
		<div class="main_container">
			<!-- sidebar -->
			<div th:insert="fragments/sidebar :: sidebar" th:remove="tag"></div>
			<!-- sidebar -->
			<!-- top navigation -->
			<div th:insert="fragments/top_nav :: top_nav" th:remove="tag"></div>
			<!-- /top navigation -->
			<!-- top navigation -->
			<!-- page content -->
			<div class="right_col" role="main">
				<!--START ページ名 -->
				<div class="page-title">
					<div class="title_left">
						<h3><i class="fa fa-file-text-o"></i> 資産貸出状況</h3>
					</div>
				</div>
				<!--END ページ名 -->
				<div class="clearfix"></div>
				<!--START 検索メソッド -->
				<div class="row">
					<!--START 貸出番号検索 -->
					<div class="col-md-2">
						<span class="pull-right" style="font-size: 18px;">貸出番号</span>
					</div>
					<div class="col-md-2 ">
						<input type="text" class="form-control" id="rentalNo_search"placeholder="貸出番号" maxlength="15">
					</div>
					<!--END 貸出番号検索 -->
					<!--START 返却予定日検索 -->
					<div class="col-md-2">
						<span class="pull-right" style="font-size: 18px;">返却予定日</span>
					</div>
					<div class="col-md-3">

							<div class="control-group pull-left">
								<div class="controls">
									<div class="input-prepend input-group pull-left">
										<span class="add-on input-group-addon "><i class="glyphicon glyphicon-calendar fa fa-calendar "></i></span>
										<input type="text"  name="rental_search"id="rental_search" class="form-control ">
									</div>
								</div>
							</div>

					</div>
					<!--END 返却予定日検索  -->
				</div>
				<!--END 検索メソッド  -->
				<div class="clearfix"></div>
				<!--START 管理番号検索 -->
				<div class="row">
					<!--START 検索の二行目  -->
					<div class="col-md-2">
						<span class="pull-right" style="font-size: 18px;">管理番号</span>
					</div>
					<div class="col-md-2">
						<input type="text" class="form-control" placeholder="管理番号" id="assetNumber_search" maxlength="15">
					</div>
					<!--END 管理番号検索 -->
					<!--START 検索の二行目  -->
						<div class="col-md-2">
						<span class="pull-right" style="font-size: 18px;">区分</span>
					</div>
					<div class="col-md-2">
						<select class="form-control" id="asset_search" style="width: 120px;">
							<option value="">全体</option>
							<option th:each="code : ${kubunCode}" th:value="${code.codeDetailId}" th:inline="text">[[${code.codeDetailName}]]</option>
						</select>
					</div>
					<!--END 管理番号検索 -->
				</div>
				<!--END 検索の二行目 -->
				<div class="clearfix"></div>
				<!--START 検索の三行目  -->
				<div class="row">
					<!--START 貸出登録ボタン -->
					<div class="col-md-2 pull-right">
						<button type="button" id="deleteButton" class="btn btn-success pull-right" onclick="modalInsert()"><i class="fa fa-pencil-square" aria-hidden="true"></i> 貸出登録</button>
					</div>
				</div>
				<!--END 貸出登録ボタン -->
				<!--END 検索の三行目 -->
						<div class="clearfix"></div>
				<!--START 貸出リスト -->
				<div class="row">
					<div class="x_panel">
						<div class="x_content">
							<table class="table table-bordered jambo_table bulk_action" id="table1" style="width: 100%; text-align: center;">
								<thead class="thead-light">
									<tr class="headings">
										<th class="col-md-1">貸出番号</th>
										<th class="col-md-1">管理番号</th>
										<th class="col-md-1">区分</th>
										<th class="col-md-1">場所</th>
										<th class="col-md-1">使用者</th>
										<th class="col-md-1">貸出日</th>
										<th class="col-md-1">返却予定日</th>
										<th class="col-md-2"></th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
						</div>
					</div>
					<!--END 貸出リスト -->
					<!--update modal -->
					<div class="row">
						<div class="modal" id="modal3d" tabindex="-1" role="dialog"style="display: none;" aria-hidden="true">
							<div class="modal-dialog modal-lg" role="document">
								<div class="modal-content">
									<div class="modal-header">
									<!--START 変更モーダルの戻るボタン -->
										<button type="button" class="close" data-dismiss="modal"aria-label="Close"><span aria-hidden="true">×</span></button>
									<!--END 変更モーダルの戻るボタン -->
										<h3 class="modal-title"><i class="fa fa-pencil-square" aria-hidden="true" ></i> 貸出情報変更</h3>
									</div>
									<div class="modal-body">
										<div class="container-fluid">
											<div class="row" id="rowUpdate">
												<div class="col-md-12" id="moddal_update">
													<div class="x_panel">
														<div class="x_content">
														<!--START 変更モーダルのフォーム -->
															<form action="" id="updateForm" method="POST" role="form"class="form-horizontal">
															<!--START 貸出日と返却予定日の変更 -->
																<div class="form-group row">
																	<label class="control-label col-md-2">貸出日<span style="color: red; font-size: 18px;">*</span></label>
																	<div class="col-md-3">
																		<div class="input-group date" id="rentalDay_search">
																			<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
																			<input type="text" class="form-control date_check" name="rentalDay_view" id="rentalDay_view">
																		</div>
																	</div>
																	<label class="control-label col-md-2">返却予定日<span style="color: red; font-size: 18px;">*</span></label>
																	<div class="col-md-3">
																		<div class="input-group date" id="returnPeriod_search" name="myDatepicker">
																		<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
																			<input type="text" class="form-control date_check" name="returnPeriod_view" id="returnPeriod_view">
																		</div>
																	</div>
																</div>
																<!--END 貸出日と返却予定日の変更 -->

																<!--START 貸出者の変更 -->
																<div class="form-group row">
																	<label class="control-label col-md-2">貸出者<span style="color: red; font-size: 18px;">*</span></label>
																	<div class="col-md-8">
																		<input type="text" id="applicantId_view" name="applicantId_view" class="form-control" />
																	</div>
																</div>
																<!--END 貸出者の変更 -->
																	<!--START 使用者の変更 -->
																<div class="form-group row">
																	<label class="control-label col-md-2">使用者<span style="color: red; font-size: 18px;">*</span></label>
																	<div class="col-md-8">
																		<input type="text" id="rentalUserId_view" name="rentalUserId_view" class="form-control" />
																	</div>
																</div>
																<!--END 使用者の変更 -->
																		<!--START 承認者の変更 -->
																<div class="form-group row">
																	<label class="control-label col-md-2">承認者<span style="color: red; font-size: 18px;">*</span></label>
																	<div class="col-md-8">
																		<input type="text" id="approver_view" name="approver_view" class="form-control" />
																	</div>
																</div>
																<!--END 承認者の変更 -->
																<!--START 貸出番号の表示（変更不可能） -->
																<div class="form-group row">
																	<label class="control-label col-md-2">貸出番号</label>
																	<div class="col-md-8">
																		<input type="text" id="rentalNo_view" name="rentalNo_view"readonly="readonly" class="form-control" />
																	</div>
																</div>
																<!--END 貸出番号の表示（変更不可能） -->
																<!--START 管理番号の表示（変更不可能） -->
																<div class="form-group row">
																	<label class="control-label col-md-2">管理番号</label>
																	<div class="col-md-8">
																		<input type="text" id="assetNumber_view" name="assetNumber_view" readonly="readonly" class="form-control" />
																	</div>
																</div>
																<!--END 管理番号の表示（変更不可能） -->
																<!--START 区分と貸出者の変更（変更不可能） -->
																<div class="form-group row">
																	<label class="control-label col-md-2">区分</label>
																	<div class="col-md-8">
																		<input type="text" id="codeDetailName_view" name="codeDetailName_view"readonly="readonly" class="form-control" />
																	</div>
																</div>
																<!--END 区分と貸出者の変更（変更不可能） -->
																<!--START 用途の変更 -->
																<div class="form-group row">
																	<label class="control-label col-md-2">用途<span style="color: red; font-size: 18px;">*</span></label>
																	<div class="col-md-8">
																		<input type="text" id="purpose_view" name="purpose_view" class="form-control" />
																	</div>
																</div>
																<!--END 用途の変更 -->
																<!--START 場所の変更 -->
																<div class="form-group row">
																	<label class="control-label col-md-2">場所<span style="color: red; font-size: 18px;">*</span></label>
																	<div class="col-md-8">
																		<input type="text" id="storageLocation_view" name="storageLocation_view" class="form-control" />
																	</div>
																</div>
																<!--END 場所の変更 -->
																<!--START 特記事項の変更 -->
																<div class="form-group row">
																	<label class="control-label col-md-2">特記事項</label>
																	<div class="col-md-8 table-responsive table-wrapper-scroll-y my-custom-scrollbar-update">
																		<textarea id="speciality_view" name="speciality_view" class="form-control col-md-9" style="height:100px;"></textarea>
																	</div>
																</div>
																<!--END 特記事項の変更 -->
																<!--START Hidden資産シークエンス -->
																<input type="hidden" id="assetSeq_hidden" class="form-control" />
																<!--END Hidden資産シークエンス -->
															</form>
															<!--END 変更モーダルのフォーム -->
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									<!--START 変更ボタンと戻るボタン -->
									<div class="modal-footer">
										<button type="button" class="btn btn-warning pull-left" id="updateButton" onclick="updateRental()">変更</button>
										<button type="button" class="btn btn-secondary" data-dismiss="modal">戻る</button>
									</div>
									<!--END 変更ボタンと戻るボタン -->
								</div>
							</div>
						</div>
					</div>
					<!-- /update modal -->
					<!--insert modal -->
					<div class="row">
						<div class="modal" id="modal3d2" tabindex="-1" role="dialog" style="display: none;" aria-hidden="true">
							<div class="modal-dialog modal-lg" role="document">
								<div class="modal-content">
									<div class="modal-header">
										<!--START 変更モーダルの戻るボタン -->
										<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
										<!--END 変更モーダルの戻るボタン -->
										<h3 class="modal-title"><i class="fa fa-pencil-square" aria-hidden="true"></i> 貸出登録</h3>
									</div>
									<div class="modal-body" id="insert_modalBody">
											<div class="x_panel" style="padding:0;">
												<div class="x_content">
													<!--START 登録フォーム -->
													<form action="" id="insertForm" method="POST" role="form">
														<!--START 貸出日と返却予定日の入力 -->
														<div class="form-group row ">
															<!--START 貸出日の入力 -->
															<label class="control-label col-md-2">貸出日<span style="color: red; font-size: 18px;">*</span></label>
															<div class="col-md-3"style="padding:0px;">
																<div class="input-group date" id="rentalsDay_search" name="rentalsDay_search">
																	<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
																	<input type="text" class="form-control date_check" name="rentalDay" id="todayDate" th:value="${#dates.format(date,'yyyy-MM-dd')}">
																</div>
															</div>
															<!--END 貸出日の入力 -->
															<!--START 返却予定日の入力 -->
															<label class="control-label col-md-2">返却予定日<span style="color: red; font-size: 18px;">*</span></label>
															<div class="col-md-4" style="padding:0px;">
																<div class="input-group date" id="myDatepicker" name="myDatepicker" style="float: left">
																<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
																	<input type="text" class="form-control date_check" name="returnPeriod" id="returnPeriod" />
																</div>
															</div>
															<!--END 返却予定日の入力 -->
														</div>
														<!--END 貸出日と返却予定日の入力 -->
														<!--START 場所入力とマスタコードの選択 -->
														<div class="form-group row">
															<!--START 場所入力 -->
															<label class="control-label col-md-2" style="float: left">場所<span style="color: red; font-size: 18px;">*</span></label>
															<div class="col-md-3 input-group " style="float: left">
																<input type="text" id="storageLocation" name="storageLocation" value="自社" class="form-control col-md-4">
															</div>
															<!--END 場所入力 -->
															<!--START マスタコードの選択 -->
															<label class="control-label col-md-2"style="float: left">分類<span style="color: red; font-size: 18px;">*</span></label>
															<div class="col-md-4 input-group " style="float: left" th:if="${kubunCode} != null">
																<select class="form-control" id="singleSelect" name="singleSelect" onchange="getSubItem()">
																	<option value="">選択</option>
																	<option th:each="productKindCode : ${kubun}" th:value="${productKindCode.codeDetailId}" th:text="${productKindCode.codeDetailName}"></option>
																</select>
															</div>
															<!--END マスタコードの選択 -->
															<div class="col-md-3">
																<p th:unless="${kubunCode} != null">データがありません</p>
															</div>
														</div>
														<!--END 場所入力とマスタコードの選択-->
														<!--START 用途の入力と詳細コード名の選択 -->
														<div class="form-group row">
															<!--START 用途の入力 -->
															<label class="control-label col-md-2" style="float: left">用途<span style="color: red; font-size: 18px;">*</span></label>
															<div class="col-md-3  input-group" style="float: left">
																<input type="text" class="form-control col-md-4" name="purpose" id="purpose" value="勤務">
															</div>
															<!--END 用途の入力 -->
															<!--START 詳細コード名の選択-->
															<label class="control-label col-md-2" style="float: left">種類<span style="color: red; font-size: 18px;">*</span></label>
															<div class="col-md-4 input-group " style="float: left">
																<select class="select2_multiple form-control" id="sub_singleSelect" name="sub_singleSelect" onchange="getSubSubItem()">
																	<option value="">選択</option>
																</select>
															</div>
															<!--END 詳細コード名の選択-->
														</div>
														<!--END 用途の入力と詳細コード名の選択 -->
														<!--START BP社名の入力と資産管理番号の選択 -->
														<div class="form-group row">
															<!--START BP社名の入力-->
															<label class="control-label col-md-2" style="float: left">BP社名</label>
															<div class="col-md-3 input-group " style="float: left">
																<input type="text" id="bpName" name="bpName" class="form-control col-md-4">
															</div>
															<!--END BP社名の入力-->
															<!--START 資産管理番号の選択-->
															<label class="control-label col-md-2" style="float: left">選択<span style="color: red; font-size: 18px;">*</span></label>
															<div class="col-md-4 input-group " style="float: left">
																<select class="select2_multiple form-control" id="sub_subSelect" name="sub_subSelect">
																	<option value="">選択</option>
																</select>
															</div>
															<!--END 資産管理番号の選択-->
														</div>
														<!--END BP社名の入力と資産管理番号の選択-->
														<!--START 貸出者,使用者,承認者,特記事項の入力 -->
														<div class="fomr-group col-md-5">
														<!--START 貸出者の入力 -->
														<div class="form-group row " style="clear:left;">
															<label class="control-label col-md-4"style="float: left; padding-fight:20;">貸出者<span style="color: red; font-size: 18px;">*</span></label>
															<div class=" col-md-7 input-group " style="width:61.7%;margin-left:4%;float: left;">
																<input type="text" name="applicantId" id="applicantId" required class="form-control col-md-9" />
															</div>
														</div>
														<!--END 貸出者の入力 -->

														<!--START 使用者の入力 -->
														<div class="form-group row "  style="clear:left;">
															<label class="control-label col-md-4" style="float: left">使用者<span style="color: red; font-size: 18px;">*</span></label>
															<div class=" col-md-7 input-group " style="width:61.7%;margin-left:4%;float: left;">
																<input type="text" name="rentalUserId" id="rentalUserId" required class="form-control col-md-9" />
															</div>
														</div>
														<!--END 使用者の入力 -->
														<!--START 承認者の入力 -->
														<div class="form-group row "  style="clear:left;">
															<label class="control-label col-md-4"style="float: left">承認者<span style="color: red; font-size: 18px;">*</span></label>
															<div class=" col-md-7 input-group " style="width:61.7%;margin-left:4%;float: left;">
																<input type="text" name="approver" id="approver" required class="form-control col-md-9" />
															</div>
														</div>
														<!--END 承認者の入力 -->
														</div>
														<!--START 特記事項の入力 -->
														<div class="fomr-group col-md-7">
															<div class="form-group row ">
																<label class="control-label col-md-3">特記事項</label>
																<textarea id="speciality" name="speciality" class="form-control col-md-8" style="margin-left:18px;height:150px;width:58%; "></textarea>
															</div>
														</div>
														<!--END 特記事項の入力 -->
														<!--END 貸出者,使用者,承認者,特記事項の入力-->
														<!--START 追加ボタン -->
														<div class="form-group row">
															<div class="col-md-12  ">
																<input type="button" class="btn btn-primary pull-right"id="button1" onclick="writeItem();" value="追加" />
															</div>
														</div>
														<!--END 追加ボタン -->
													</form>
													<!--END 登録フォーム -->
												</div>
											</div>
										<!--START 貸出目録 -->
										<div class="x_panel" style="padding:0;">
											<div class="x_title">
												<h2>貸出目録</h2>
												<div class="clearfix"></div>
											</div>
											<div class="x_content">
												<div class="form-group row" style="text-align: center;">
													<table id="selectedAsset" style="font-size :12px;">
														<thead>
															<tr>
																<th class="col-md-1" id="applicantId_insert">貸出者</th>
																<th class="col-md-1" id="rentalUserId_insert">使用者</th>
																<th class="col-md-1" id="approver_insert">承認者</th>
																<th class="col-md-1" id="item1_insert">種類</th>
																<th class="col-md-1" id="assetNumber_insert">管理番号</th>
																<th class="col-md-1" id="purpose_insert">用途</th>
																<th class="col-md-1" id="storageLocation_insert">場所</th>
																<th class="col-md-1" id="bpName_insert">BP社名</th>
																<th class="col-md-1" id="rentalDay_insert">貸出日</th>
																<th class="col-md-1" id="returnPeriod_insert">返却予定日</th>
																<th class="col-md-1" id="cancel_insert"></th>
															</tr>
														</thead>
														<tbody>
														</tbody>
													</table>
												</div>
											</div>
										</div>
										<!--END 貸出目録 -->
									</div>
									<!--START 貸出ボタンと戻るボタン -->
									<div class="modal-footer">
										<input type="button"class="btn btn-primary pull-left btn-success"id="insertButton" value="貸出" onclick="rentalItem();" />
										<button type="button" class="btn btn-secondary" id="canelButton">戻る</button>
									</div>
									<!--END 貸出ボタンと戻るボタン -->
								</div>
							</div>
						</div>
					</div>
					<!-- /insert modal -->
				</div>
			</div>
		</div>
		<!-- /page content -->
		<!-- footer content -->
		<div th:insert="fragments/footer :: footer" th:remove="tag"></div>
		<!-- /footer content -->
	</div>
	<!-- jQuery -->
	<script src="../vendors/jquery/dist/jquery.min.js"></script>
	<!-- jquery-validation-1.19.1 -->
	<script src="../vendors/jquery-validation-1.19.1/dist/jquery.validate.min.js"></script>
	<!-- Bootstrap -->
	<script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
	<!-- jquery-ui -->
	<script th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>
	<!-- DataTable -->
	<script th:src="@{/DataTables-1.10.20/js/jquery.dataTables.min.js}"></script>
	<script th:src="@{/DataTables-1.10.20/js/dataTables.bootstrap4.min.js}"></script>
	<!-- FastClick -->
	<script src="../vendors/fastclick/lib/fastclick.js"></script>
	<!-- NProgress -->
	<script src="../vendors/nprogress/nprogress.js"></script>
	<!-- iCheck -->
	<script src="../vendors/iCheck/icheck.min.js"></script>
	<!-- bootstrap-datetimepicker -->
	<script src="../vendors/moment/min/moment.min.js"></script>
	<script src="../vendors/moment/locale/ja.js"></script>

	<script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
	<script src="../vendors/bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
	<!-- Custom Theme Scripts -->
	<script src="../build/js/custom.min.js"></script>
	<!-- page script -->
	<script th:inline="javascript">
    /*<![CDATA[*/
		//特殊文字を削除するメソッド

    	function specialCharRemove(obj) {

			/* var pattern = /[^(\u30a0-\u30ff\u3040-\u309f\u3005-\u3006\u30e0-\u9fcfㅣa-zA-Z0-9ㅣ\n)]/gi; */
			//タグ削除
			var re = /[<][^>]*[>]/gi;
			if(re.test(obj)){
				obj = obj.replace(re,"");
			}
			return obj;
		}
    	//全ての文字を一気に変えるためのメソッド
    	String.prototype.replaceAll = function(org, dest) {
    	    return this.split(org).join(dest);
    	}
			/*validationの重なるエラーメッセージ  */
    		$.validator.messages.number = '有効な数字を入力';
    		$.validator.messages.maxlength = '{0} 文字以下を入力';
			/*選択した資産はセレクトできなしようにする為のマップ*/
    	    var assetKey = new Map();
			/*最初にデータテーブルを使うための変数を宣言*/
			var modalesectiondata = null;
			/*資産区分コードを最初に取り込む*/
    		var kubunCodeMap = new Map();
    		/*資産区分コードを最初に取り込む*/
    		var kubunItemMap = new Map();
    		/*listで区分コードを呼び出す  */
			var kubunCode = /*[[${kubunCode}]]*/;
			/* keyはitem1でcodeDetailNameがvalueになるmapを作る */
			kubunCode.forEach(function( value ) {
			kubunCodeMap.set(value.item1,value.codeDetailName);
    		});
			/* keyはcodeDetailIdでcodeDetailNameがvalueになるmapを作る */
			kubunCode.forEach(function( value ) {
				kubunItemMap.set(value.codeDetailId, value.codeDetailName);});
    		var statusCodeMap = new Map();
    		/*listで状態コードを呼び出す  */
    		var statusCode = /*[[${statusCode}]]*/;
    		/* keyはcodeDetailIdでcodeDetailNameがvalueになるmapを作る */
    		statusCode.forEach(function( value ) {
    		statusCodeMap.set(value.codeDetailId, value.codeDetailName);
    		});




   		 //START ONLOADのメソッド
        $(function(){
        	//登録フォームの貸出日のカーレンダー
       	 	$('#rentalsDay_search').datetimepicker({
                 format: 'YYYY-MM-DD'
             });
       		//変更フォームの貸出日のカーレンダー
            $('#rentalDay_search').datetimepicker({
                format: 'YYYY-MM-DD'
            });
          	//登録フォームの返却予定日のカーレンダー
            $('#myDatepicker').datetimepicker({
                format: 'YYYY-MM-DD'
            });
          	//変更フォームの返却予定日のカーレンダー
            $('#returnPeriod_search').datetimepicker({
                format: 'YYYY-MM-DD'
            });
            /*二つ一つの日付を選べるカーレンダーのフォーマットを決める  */
        	$('#rental_search').daterangepicker({
        		todayBtn: "linked",
       	    	clearBtn: true,
				startDate: moment().add(-1, "months"),
				endDate: moment(),
			 locale: {
			         applyLabel: '選択',
			         cancelLabel: 'クリア',
			         format: 'YYYY/MM/DD'
			   }, function(start, end, label) {
			       console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
			   }
			});
        	/*!貸出日で貸出情報を探す */
    		$('#rental_search').on('cancel.daterangepicker', function(ev, picker) {
				  //do something, like clearing an input
					$('#rental_search').val('');
				    var date = $("#rental_search").val();
				    modalesectiontable
				    .column(1)
				    .search(date)
				    .draw();
			});
        	/*カーレンダーで期間を無くして今貸出されてるものを全部見えることにする */
        	$('#rental_search').val('');
     		//START データテーブルをセッティングする
            var modalesectiontable = $("#table1").DataTable({
            	"language": {
            		"info":           " _START_ ~ _END_ の _TOTAL_ 件",
            		"infoEmpty":      " 0 ~ 0 の 0 件",
            	    "infoFiltered":   "",
            	    "emptyTable": "表にデータがない",
            	    "paginate": {
            	        "first":      "最初",
            	        "last":       "最後",
            	        "next":       "次",
            	        "previous":   "前"
            	    }
                },
            	fixedHeader: true,
            	"processing": true,
            	"serverSide": true,
            	"start": 0,
                "length": 10,
                "searching": false,
                "paging": true,
                "lengthChange": false,
                "ordering": false,
                "ajax": {
                	url: /*[[@{/rental/getRentalList}]]*/ 'rental/getRentalList',
                	type: "POST",
                	dataType: "json",
                	contentType: 'application/JSON',
                	data: function ( d ) {
					/*二つの検索条件
					 *1.資産ナンバーで探す
					 *2.貸出日で探す
					 */
                		d.columns[0].search.value = $('#assetNumber_search').val();
                   		d.columns[1].search.value = $('#rental_search').val();
                   		d.columns[2].search.value = $('#rentalNo_search').val();
                   		d.columns[3].search.value = $('#asset_search').val();
                        return JSON.stringify(d);
                    }
                },
                "Error" : function(d){
					alert("初期化不可能");
				},
				/*コンローラーで貰ったデータを元にしてデータを見せる  */
                "columnDefs": [
                	/* 貸出ナンバー */
                	{ targets: 0, data: "rentalNo"},
                	/* 資産ナンバー */
                    { targets: 1, data: "assetNumber"},
                    /*区分名 */
                    { targets: 2, data: function ( d ) {
                    	return kubunItemMap.get(d.kubunCode);
                    }},
                    /* 使う場所 */
                    { targets: 3, data: function ( d ) {
                    	if(d.storageLocation == '') {
                    		return '-';
                    	} else {
                    		return d.storageLocation;
                    	}
                    }},
                    { targets: 4, data: "rentalUserId"},
                    /* 貸出日 */
                    { targets: 5, data: function ( d ) {
                    	var str = d.rentalDay;
                    	return str.substring(0, 4) + "-" + str.substring(4, 6) + "-" + str.substring(6, 8);
                    }},
                    /* 返却予定日 */
                    { targets: 6, data: function ( d ) {
                    	var str = d.returnPeriod;
                    	return str.substring(0, 4) + "-" + str.substring(4, 6) + "-" + str.substring(6, 8);
                    }},
					/* 変更ボタンと返却ボタン */
                    { targets: 7,
                    	data: "description_u",
                        render: function ( data, type, row, meta ) {
                          return '<button type="button" class="btn btn-warning" id="updateButton" onclick = "researchRental(' + row.assetSeq + ')" >変更</button>'
                          +'<button type="button" class="btn btn-danger" id="deleteButton" onclick = "deleteAsset(' + row.assetSeq + ')" >返却</button>';
                           }
                    }
                ]
            });


    	    /*登録を取り消したら作動するメソッド  */
    	  $("#canelButton").on("click", function() {
    	    	//貸与目録をリセットする
    	 	$('#selectedAsset > tbody').empty();
    	    	//登録フォームのテキストをリセットする
    	    $('#insertForm').find('input[type="text"], textarea').val('');
    	     	//登録フォームのセレクトをリセットする
    		$('select').find('option:first').attr('selected', 'selected');
    	     	//START登録フォームのデートをリセットする
    			var today = new Date();
    			var dd = today.getDate();
    			var mm = today.getMonth()+1; //January is 0!
    			var yyyy = today.getFullYear();
    			if(dd<10) {
    				 dd='0'+dd
    			}
    			$('#todayDate').val(yyyy+"-"+mm+"-"+dd);
    			//END登録フォームのデートをリセットする
    			   $('#storageLocation').val('自社');
    			   $('#purpose').val('勤務');

    	    	  $('#modal3d2').modal("hide");
    	    });
        	//END データテーブルをセッティングする
            /*資産ナンバーを貰ってメイン画面のデータを変える*/
            $('#assetNumber_search').on( 'keyup', function () {
            	$('#assetNumber_search').val(this.value.replace(new RegExp("'", 'g'), ''));
            	modalesectiontable.column(0).search( this.value ).draw();
            } );
            /*貸与日を貰ってメイン画面のデータを変える*/
            $("#rental_search").change(function () {
                var date = $("#rental_search").val();
                modalesectiontable.column(1).search(date).draw();
            });
            /*貸与ナンバーを貰ってメイン画面のデータを変える*/
            $("#rentalNo_search").on( 'keyup',function () {
            	$('#rentalNo_search').val(this.value.replace(new RegExp("'", 'g'), ''));
                modalesectiontable .column(2).search(this.value).draw();
            });
            /*資産を貰ってメイン画面のデータを変える*/
            $('#asset_search').change(function () {
            	$('#asset_search').val(this.value);
            	modalesectiontable.column(3).search( this.value ).draw();
            } );
        })
    //END ONLOADのメソッド
    /*]]>*/
    </script>
	<script th:inline="javascript">
	/*<![CDATA[*/

	/*データのupdateメソッド
	引数はrentalのドメインを作ってajaxを利用する
	戻り値も無し
	*/
	function updateRental(){
			 /* 最初に日付を貰うときの有効性検査  */
			 var datatimeRegexp = /[0-9]{4}-(0?[1-9]|1[012])-(0?[1-9]|[12][0-9]|3[01])/;
	         var form = $('#updateForm');
			 /*START 貸与日と返却予定日の差を計る */
	         var startDate = $('#rentalDay_view').val(); //2017-12-10
	         var startDateArr = startDate.split('-');
	         var endDate = $('#returnPeriod_view').val(); //2017-12-09
	         var endDateArr = endDate.split('-');
	         var startDateCompare = new Date(startDateArr[0], parseInt(startDateArr[1])-1, startDateArr[2]);
	         var endDateCompare = new Date(endDateArr[0], parseInt(endDateArr[1])-1, endDateArr[2]);
	         /*END 貸与日と返却予定日の差を計る */
	         //貸与日と返却予定日を比較する
	         if(startDateCompare.getTime() > endDateCompare.getTime()) {
	             alert("貸与日と返却予定日を確認してください。");
	             return false;
	         }
	         /*START 計算した貸与日と返却予定日の差がプラスであれば下の有個性検査を行う  */
	         form.validate({
	             rules: {
	             	rentalUserId_view : {
	             		required : true,
	             		maxlength : 15
	             	},
	             	purpose_view : {
	             		required : true,
	             		maxlength : 15
	             	},
	             	speciality_view : {

	             		maxlength : 200
	            	},
	             	storageLocation_view : {
	             		required : true,
	             		maxlength : 20
	             	},
	             	returnPeriod_view : {
	             		required : true

	             	},
	             	approver_view : {
	             		required : true

	             	},
	             	rentalDay_view : {
	             		required : true
	             	},
	             	applicantId_view : {
	             		required : true,
	             		maxlength : 15
	             	},
	             	bpName_view : {
	             		maxlength : 15
	             	}
	             },
	             messages: {
	             	rentalUserId_view : {
	             		required : "使用者を入力してください"
	             	},
	             	approver_view : {
	             		required : "承認者を入力してください"
	             	},
	             	purpose_view : {
	             		required : "用途を入力してください"
	             	},
	             	storageLocation_view : {
	             		required : "場所を入力してください"
	             	},
	             	returnPeriod_view : {
	             		required : "返却予定日を指定してください"
	             	},
	             	rentalDay_view : {
	             		required : "貸与日を指定してください"
	             	},
	             	applicantId_view : {
	             		required : "貸与者を指定してください"
	             	}
	             },
	             /* カーレンダーの下にエラーを出力する  */
	             errorPlacement: function(error, element) {
	                 if (element.attr("name") == "returnPeriod") {
	                   error.insertAfter("#returnPeriod_search");
	                 }else if(element.attr("name") == "rentalDay") {
	                   error.insertAfter("#rentalDay_search");
	                 }
	                 else {
	                   error.insertAfter(element);
	                 }
	             }
	         });
	         /*END 計算した貸与日と返却予定日の差がプラスであれば下の有個性検査を行う  */
			/* 有効性を通過したら下のメソッドを行う */
         	if (form.valid()) {
	     		/*変更してもらったデータにもし-の文字があればなくすメソッド
     		/* 変更する情報をオブジェクト化する  */
        	var rental = new Object();
        	rental.rentalNo=specialCharRemove($('#rentalNo_view').val());
        	rental.approver=specialCharRemove($('#approver_view').val());
        	rental.assetNumber=specialCharRemove($('#assetNumber_view').val());
        	rental.codeDetailName=specialCharRemove($('#codeDetailName_view').val());
        	rental.purpose=specialCharRemove($('#purpose_view').val());
        	rental.storageLocation=specialCharRemove($('#storageLocation_view').val());
        	rental.rentalDay=$('#rentalDay_view').val().replaceAll("-","");
        	rental.speciality=specialCharRemove($('#speciality_view').val());
        	rental.returnPeriod=$('#returnPeriod_view').val().replaceAll("-","");
        	rental.rentalUserId=specialCharRemove($('#rentalUserId_view').val());
        	rental.bpName=specialCharRemove($('#bpName_view').val());
        	rental.applicantId=specialCharRemove($('#applicantId_view').val());
        	rental.assetSeq=specialCharRemove($('#assetSeq_hidden').val());
            		$.ajax({
         			   type  : "POST",
         			   url : "/rental/updateRental",
         				dataType : "json",
         				"contentType" : "application/JSON",
         				data : JSON.stringify(rental),
        				success : function(data){
		/* もしアップデートが良くできたら0以上の数字をもらえる  */
        if(data>0){
        	location.href = '/rental';
        }
        				},
        				"Error" : function(){
        					alert("変更不可能");
        				}
         	});
         }
	}
//貸与情報を変更する為のメソッド
function researchRental(assetSeq){
	$.ajax({
		   type  : "POST",
		   url : "/rental/researchRental",
			dataType : "json",
			"contentType" : "application/JSON",
			data : JSON.stringify(assetSeq),
			success : function(data){
				var returnPeriod=data.returnPeriod;
				returnPeriod=returnPeriod.substring(0, 4) + "-" + returnPeriod.substring(4, 6) + "-" + returnPeriod.substring(6, 8);
				var	rentalDay=data.rentalDay;
				rentalDay=rentalDay.substring(0, 4) + "-" + rentalDay.substring(4, 6) + "-" + rentalDay.substring(6, 8);
			$('#rentalNo_view').val(data.rentalNo);
			$('#approver_view').val(data.approver);
			$('#assetNumber_view').val(data.assetNumber);
			$('#codeDetailName_view').val(kubunItemMap.get(data.kubunCode));
			$('#purpose_view').val(data.purpose);
			$('#storageLocation_view').val(data.storageLocation);
			$('#rentalDay_view').val(rentalDay);
			$('#speciality_view').val(data.speciality);
			$('#returnPeriod_view').val(returnPeriod);
			$('#rentalUserId_view').val(data.rentalUserId);
			$('#applicantId_view').val(data.applicantId);
			$('#assetSeq_hidden').val(data.assetSeq);
			}
	});
	/* モーダルを閉じるボタン以外では閉じれない  */
	$('#modal3d').modal({ backdrop: 'static', keyboard: false});
}
	/* 返却ボタンを押すと確認して返却を行う */
	function deleteAsset(assetSeq){
		 var result = confirm('返却しますか？');
		 /*もしyesであれば選択した行のデータを元にして貸与テーブルのデータを削除する  */
		 if(result) {
				$.ajax({
					   type  : "POST",
					   url : "/rental/returnAsset",
						dataType : "json",
						"contentType" : "application/JSON",
						data : JSON.stringify(assetSeq),
						"Error" : function(d){
	    					alert("返却不可能");
	    				}
			});
			 location.href = '/rental';
		 }
		}
	/* モーダルボタンをクリックしてインサートする画面を開く  */
		function modalInsert() {
		    var user = /*[[${session.id}]]*/ 'user';
			if(user==null){alert("ログインしてください");
			/* モーダルを閉じるボタン以外では閉じれない  */
    		}else{
    			$('#modal3d2').modal({    backdrop: 'static', keyboard: false});
    		}
    	}
		function getSubItem() {
			/* 最初の選択地で選択してもらったデータを元にして次の選択地をセッティングする  */
			var kub =/*[[${kubunCode}]]*/;
			$('#singleSelect').click(function() {
						/* 二番目のボタンが押されたら下のメソッドが行われる  */
						/* まだ何も選択してなければ下のメソッドは実行されない
						* 当てはまるデータがあれば選択地にセティングする
						*/
						if($('#singleSelect option:selected').val()!=""){
						var item=$('#singleSelect option:selected').val();
							var html = '<option value="">選択</option>';
							kub.forEach(function(value) {
								if(value.item1==item){
									html += '<option value="' +value.codeDetailId + '">'+ value.codeDetailName + '</option>';
								}
							});
							$('#sub_singleSelect').html(html);
						}
			});
		}
		function getSubSubItem() {
			/* 三番目のボタンが押されたら下のメソッドが行われる  */
			$('#sub_singleSelect').click(function() {
						/* まだ何も選択してなければ下のメソッドは実行されない
						* 当てはまるデータがあれば選択地にセティングする
						*/
				if($('#sub_singleSelect option:selected').val()!=""){
					var selectedItem = $('#sub_singleSelect option:selected').val();
					selectedItem=selectedItem.replace(/[^0-9]/g,'');
					/*ajaxを使って実際に使えるものかを確認する  */
					$.ajax({
			   			"url" : "/rental/getAssetList",
			    		"type" : "post",
			   	 		"dataType": "json",
			   	 		"contentType": "application/JSON",
			   			"data" : selectedItem,
			   			contentType: 'application/JSON',
			   		 	"success" : function(data){
				   			var itemName=$('#sub_subSelect').val();
							var html = '<option value="">選択</option>';
							data.forEach(function(value) {
								if (!assetKey.has(value.assetSeq)){
									html += '<option value="' + value.assetSeq + '">'+ value.assetNumber + '</option>';
								}
							});
								$('#sub_subSelect').html(html);
						},
						"Error" : function(value){
							alert("貸与不可能");
								}
					});
				}
			});
		}
/* 任意でリスト化した貸与情報の中で一行だけ削除するメソッド */
 	function deleteRow(btn) {
		var assetSeq=btn.value;
	 	assetKey.delete(Number(assetSeq));
		/* もし貸与から保管に変更できたら一行を消す  */
		var row = btn.parentNode.parentNode;
		row.parentNode.removeChild(row);
	}


 function rentalItem() {
	 /* もし 一行もなければ警告する一行以上だったらページをリロードする*/
	 if($('#selectedAsset tbody tr').length==0){
			alert("貸与する物がないです。");
		}else{
			var tdArr = new Array();
			/* テーブルにある貸与情報を全て持ち込んでリスト化する */
			$('#selectedAsset tbody tr').each(function() {
				var rental =new Object();
				var cellText = $(this);
				rental.rentalUserId =specialCharRemove(cellText.find("#rentalUserId_i").text());
				rental.assetNumber =specialCharRemove(cellText.find("#assetNumber_i").text());
				rental.purpose  =specialCharRemove(cellText.find("#purpose_i").text());
				rental.approver  =specialCharRemove(cellText.find("#approver_i").text());
				rental.storageLocation =specialCharRemove(cellText.find("#storageLocation_i").text());
				rental.speciality =specialCharRemove(cellText.find("#speciality_i").text());
				rental.returnPeriod =cellText.find("#returnPeriod_i").text().replaceAll("-","");
				rental.assetSeq=specialCharRemove(cellText.find("#assetSeq_i").text());
				rental.applicantId =specialCharRemove(cellText.find("#applicantId_i").text());
				rental.rentalDay=cellText.find('#rentalDay_i').text().replaceAll("-","");
				rental.bpName=specialCharRemove(cellText.find("#bpName_i").text());
				rental.insertId = /*[[${session.id}]]*/ 'user';
				rental.updateId = /*[[${session.id}]]*/ 'user';
				tdArr.push(rental);
			});
			/* リスト化された貸与情報をデータテーブルに書き込む  */
			$.ajax({
				"url" : "/rental/addRental",
				"type" : "post",
				"dataType": "json",
				"contentType": "application/JSON",
				"data" : JSON.stringify(tdArr),
				"success" : function(d){
					assetKey.clear();
					},
				"Error" : function(d){
					alert("貸与不可能");
				}

			});
			location.href = '/rental';
		}

 }
    //貸与目録に追加する
	function writeItem() {
			/* 有効性の検査を行う  */
        	var datatimeRegexp = /[0-9]{4}-(0?[1-9]|1[012])-(0?[1-9]|[12][0-9]|3[01])/;
            var form = $('#insertForm');
            var startDate =$("#todayDate").val(); //2017-12-10
            var startDateArr = startDate.split('-');
            var endDate = $("#returnPeriod").val(); //2017-12-09
            var endDateArr = endDate.split('-');
            var startDateCompare = new Date(startDateArr[0], parseInt(startDateArr[1])-1, startDateArr[2]);
            var endDateCompare = new Date(endDateArr[0], parseInt(endDateArr[1])-1, endDateArr[2]);
            if(startDateCompare.getTime() > endDateCompare.getTime()) {
                alert("貸与日と返却予定日を確認してください。");
                return false;
            }
        	if($('#sub_subSelect option:selected').val()==""){
        		alert("貸与できる資産がありません。");
        		return false;
        	}
            /*START 計算した貸与日と返却予定日の差がプラスであれば下の有個性検査を行う  */
            form.validate({
                rules: {
                	rentalUserId : {
                		required : true,
                 		maxlength : 15
                	},
                	purpose : {
                		required : true,
                 		maxlength : 15
                	},
                 	speciality : {
                 		maxlength : 200
                	},

                	approver : {
                 		maxlength : 15,
                 		required : true
                	},
                	storageLocation : {
                		required : true,
                 		maxlength : 20
                	},
                	returnPeriod : {
                		required : true
                	},
                	rentalDay : {
                		required : true
                	},
                	applicantId : {
                		required : true,
                 		maxlength : 15
                	},
                 	bpName : {
                 		maxlength : 15
                 	}
                },
                messages: {
                	rentalUserId : {
                		required : "使用者を入力してください"
                	},
                	approver : {
                		required : "承認者を入力してください"
                	},
                	purpose : {
                		required : "用途を入力してください"
                	},

                	storageLocation : {
                		required : "場所を入力してください"
                	},
                	returnPeriod : {
                		required : "返却予定日を指定してください"
                	},
                	rentalDay : {
                		required : "貸与日を指定してください"
                	},
                	applicantId : {
                		required : "貸与者を指定してください"
                	}
                },
            	errorPlacement: function(error, element) {
	                if (element.attr("name") == "returnPeriod") {
	                  error.insertAfter("#myDatepicker");
	                }else if(element.attr("name") == "rentalDay") {
	                  error.insertAfter("#rentalsDay_search");
	                }
	                else {
	                  error.insertAfter(element);
	                }
            }
        });
            /*END 計算した貸与日と返却予定日の差がプラスであれば下の有個性検査を行う  */
           /*START 有効性を通過したら下のメソッドを行う */
            if (form.valid()) {
            	var number=$("#sub_subSelect option:selected").text();
				/* もう一回資産の情報を確認してデータを表示する */
				//ajax通信して資産ナンバーを転送して資産情報を取り込む
    			$.ajax({
    			   			"url" : "/rental/getAsset",
    			    		"type" : "post",
    			   	 		"dataType": "json",
    			   			"data" : number,
    			   			"contentType": "application/JSON",
    			   		 	"success" : function(data){
    			   		 	$('#selectedAsset tbody').append('<tr style="text-align:center;" title="特記事項： '+specialCharRemove($("#speciality").val())+'"><td id="applicantId_i">'
    			   					+specialCharRemove($('#applicantId').val())+'</td><td id="rentalUserId_i">'
    			   					+specialCharRemove($("#rentalUserId").val())+'</td><td id="approver_i">'
    			   					+specialCharRemove($("#approver").val())+'</td><td>'
    			   					+specialCharRemove($("#sub_singleSelect option:selected").text())+'</td><td id="assetNumber_i">'
    			   					+number+'</td><td id="purpose_i">'
    			   					+specialCharRemove($("#purpose").val())+'</td><td id="storageLocation_i">'
    			   					+specialCharRemove($("#storageLocation").val())+'</td><td id="speciality_i" style="display:none;">'
    			   					+specialCharRemove($("#speciality").val())+'</td><td id="bpName_i">'
    			   					+specialCharRemove($("#bpName").val())+'</td><td id="assetSeq_i" style="display:none;"> '
    				   				+data.assetSeq+'</td><td id="rentalDay_i">'
    				   				+$("#todayDate").val()+'</td><td id="returnPeriod_i">'
    				   				+$("#returnPeriod").val()+'</td><td><button value="'+data.assetSeq+'"class="btn btn-warning" id="cancelitem" onclick="deleteRow(this)">削除</button></td></tr>');
    			   		 			assetKey.set(data.assetSeq,data.assetNumber);
    			   					$(function(){  $('select').find('option:first').attr('selected', 'selected');})
    			   	 		},
    						"Error" : function(){
    							alert("貸与不可能");
    						}
    			});
            }


            /*END 有効性を通過したら下のメソッドを行う */
	}
		/*]]>*/
	</script>
</body>
</html>
