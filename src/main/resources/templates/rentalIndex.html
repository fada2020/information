<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- Meta, title, CSS, favicons, etc. -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>IT資産管理</title>

<!-- favicons -->
<link rel="icon" href="../images/aisRogo.png">
<!-- Bootstrap -->
<link href="../vendors/bootstrap/dist/css/bootstrap.min.css"
	rel="stylesheet">
<!-- Font Awesome -->
<link href="../vendors/font-awesome/css/font-awesome.min.css"
	rel="stylesheet">
<!-- NProgress -->
<link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
<!-- iCheck -->
<link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">

<!-- bootstrap-daterangepicker -->
<link href="../vendors/bootstrap-daterangepicker/daterangepicker.css"
	rel="stylesheet">
<!-- bootstrap-datetimepicker -->
<link
	href="../vendors/bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.css"
	rel="stylesheet">

<!-- Custom Theme Style -->
<link href="../build/css/custom.min.css" rel="stylesheet">

<style>
#table1 thead, th {
	text-align: center;
}

#table1 th {
	vertical-align: middle;
}

#table1 td {
	vertical-align: middle;
}

.my-custom-scrollbar {
	position: relative;
	height: 130px;
	overflow: auto;
}

.table-wrapper-scroll-y {
	display: block;
}

.error {
	color: red;
	background-color: lavender;
}

.flat {
	display: inline-block;
	width: 18px;
	height: 18px;
	border: 2px solid #bcbcbc;
	cursor: pointer;
}

.control-label {
	text-align: center;
}
</style>


</head>
<body class="nav-md">
	<div class="container body">
		<div class="main_container">
			<!-- sidebar -->
			<div th:insert="/fragments/sidebar :: sidebar" th:remove="tag"></div>
			<!-- sidebar -->

			<!-- top navigation -->
			<div th:insert="/fragments/top_nav :: top_nav" th:remove="tag"></div>
			<!-- /top navigation -->
			<!-- top navigation -->

			<!-- page content -->
			<div class="right_col" role="main">

				<div class="page-title">
					<div class="title_left">
						<h3>
							<i class="fa fa-file-text-o"></i> 貸与一覧
						</h3>
					</div>
				</div>

				<div class="clearfix"></div>

				<div class="row">
					<div class="col">
						<div class="col-md-1">
							<span class="pull-right" style="font-size: 18px;">管理番号</span>
						</div>
						<div class="col-md-2">
							<input type="text" class="form-control" placeholder="管理番号"
								id="assetNumber_search">
						</div>
						<div class="col-md-1">
							<span class="pull-right" style="font-size: 18px;">貸与番号</span>
						</div>
						<div class="col-md-2">
							<input type="text" class="form-control" id="rentalNo_search"
								placeholder="貸与番号">
						</div>
						<div class="col-md-1">
							<span class="pull-right" style="font-size: 18px;">貸与期間</span>
						</div>
						<div class="col-md-2" style="float: left;">
							<fieldset>
								<div class="control-group ">
									<div class="controls">
										<div class="input-prepend input-group">
											<span class="add-on input-group-addon"><i
												class="glyphicon glyphicon-calendar fa fa-calendar"></i></span> <input
												type="text" style="width: 200px;" name="rental_search"
												id="rental_search" class="form-control">
										</div>
									</div>
								</div>
							</fieldset>




						</div>
						<div class="col-md-1 col-md-offset-1">
							<button type="button" id="deleteButton"
								class="btn btn-primary pull-right" onclick="modalInsert()">貸与登録</button>
						</div>
						<div class="clearfix"></div>
					</div>

					<div class="x_panel">
						<div class="x_title">

							<div class="clearfix"></div>
						</div>


						<div class="x_content">
							<table class="table table-bordered jambo_table bulk_action"
								id="table1" style="width: 100%; text-align: center;">


								<thead class="thead-light">


									<tr class="headings">


										<th class="col-md-2">貸与番号</th>
										<th class="col-md-2">管理番号</th>
										<th class="col-md-1">品目</th>
										<th class="col-md-1">場所</th>
										<th class="col-md-1">使用者</th>
										<th class="col-md-1">貸与日</th>
										<th class="col-md-1">貸与期限</th>
										<th class="col-md-2"></th>


									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>


							<!--update modal -->
							<div class="modal" id="modal3d" tabindex="-1" role="dialog"
								style="display: none;" aria-hidden="true">
								<div class="modal-dialog modal-lg" role="document">
									<div class="modal-content">
										<div class="modal-header">
											<button type="button" class="close" data-dismiss="modal"
												aria-label="Close"></button>
											<h3 class="modal-title">貸与情報変更</h3>
										</div>

										<div class="modal-body">
											<div class="container-fluid">
												<div class="row" id="rowUpdate">
													<div class="col-md-12" id="moddal_update">
														<div class="x_panel">
															<div class="x_content">
																<form action="" id="updateForm" method="POST"
																	role="form" class="form-horizontal">
																	<div class="form-group row">
																		<label class="control-label col-md-2">貸与日</label>

																		<div class="col-md-3">
																			<div class="input-group date" id="rentalDay_search">
																				<input type="text" class="form-control date_check"
																					name="rentalDay" id="rentalDay_view"> <span
																					class="input-group-addon"> <span
																					class="glyphicon glyphicon-calendar"></span>
																				</span>
																			</div>
																		</div>

																		<label class="control-label col-md-2">貸与期限</label>

																		<div class="col-md-3">
																			<div class="input-group date"
																				id="returnPeriod_search" name="myDatepicker">
																				<input type="text" class="form-control date_check"
																					name="returnPeriod" id="returnPeriod_view">
																				<span class="input-group-addon"> <span
																					class="glyphicon glyphicon-calendar"></span>
																				</span>
																			</div>
																		</div>

																	</div>
																	<div class="form-group row">
																		<label class="control-label col-md-2">使用者</label>

																		<div class="col-md-9">
																			<input type="text" id="rentalUserId_view"
																				name="rentalUserId" class="form-control" />
																		</div>
																	</div>
																	<div class="form-group row">
																		<label class="control-label col-md-2">貸出者</label>

																		<div class="col-md-9">
																			<input type="text" id="applicantId_view"
																				name="applicantId" class="form-control" />
																		</div>
																	</div>


																	<div class="form-group row">
																		<label class="control-label col-md-2">貸与番号</label>

																		<div class="col-md-9">
																			<input type="text" id="rentalNo_view"
																				readonly="readonly" class="form-control" />
																		</div>
																	</div>

																	<div class="form-group row">

																		<label class="control-label col-md-2">管理番号</label>

																		<div class="col-md-9">
																			<input type="text" id="assetNumber_view"
																				readonly="readonly" class="form-control" />
																		</div>
																	</div>


																	<div class="form-group row">
																		<label class="control-label col-md-2">品目</label>

																		<div class="col-md-9">
																			<input type="text" id="codeDetailName_view"
																				readonly="readonly" class="form-control" />
																		</div>
																	</div>

																	<div class="form-group row">
																		<label class="control-label col-md-2">用途</label>

																		<div class="col-md-9">
																			<input type="text" id="purpose_view" name="purpose"
																				class="form-control" />
																		</div>
																	</div>
																	<div class="form-group row">
																		<label class="control-label col-md-2">場所</label>

																		<div class="col-md-9">
																			<input type="text" id="storageLocation_view"
																				name="storageLocation" class="form-control" />
																		</div>
																	</div>

																	<div class="form-group row">
																		<label class="control-label col-md-2">特記事項</label>
																		<div class="col-md-9">
																			<input type="text" id="speciality_view"
																				name="speciality" class="form-control" />
																		</div>

																	</div>


																	<input type="hidden" id="assetSeq_hidden"
																		class="form-control" />


																</form>
															</div>
														</div>
													</div>
												</div>




											</div>
										</div>



										<div class="modal-footer">
											<button type="button" class="btn btn-warning pull-left"
												id="updateButton" onclick="updateRental()">変更</button>
											<button type="button" class="btn btn-secondary"
												data-dismiss="modal">戻る</button>
										</div>
									</div>
								</div>
							</div>
							<!-- /update modal -->

							<!--insert modal -->
							<div class="modal" id="modal3d2" tabindex="-1" role="dialog"
								style="display: none;" aria-hidden="true">
								<div class="modal-dialog modal-lg" role="document">
									<div class="modal-content">
										<div class="modal-header">

											<h3 class="modal-title">貸与</h3>
										</div>

										<div class="modal-body" id="insert_modalBody">

											<div class="col-md-12" id="left_insert">
												<div class="x_panel">
													<div class="x_content">
														<form action="" id="insertForm" method="POST" role="form">
															<div class="form-group row ">
																<label class="control-label col-md-2">貸与日</label>
																<div class="col-md-3">
																	<div class="input-group date" id="rentalsDay_search"
																		name="rentalsDay_search">
																		<input type="text" class="form-control date_check"
																			name="rentalDay" id="todayDate"
																			th:value="${#dates.format(date,'yyyy-MM-dd')}">
																		<span class="input-group-addon"> <span
																			class="glyphicon glyphicon-calendar"></span>
																		</span>
																	</div>
																</div>
																<label class="control-label col-md-2">貸与期限</label>

																<div class="col-md-3">
																	<div class="input-group date" id="myDatepicker"
																		name="myDatepicker" style="float: left">
																		<input type="text" class="form-control date_check"
																			name="returnPeriod" id="returnPeriod" /> <span
																			class="input-group-addon"> <span
																			class="glyphicon glyphicon-calendar"></span>
																		</span>
																	</div>
																</div>

															</div>
															<div class="form-group row">
																<label class="control-label col-md-2 ">貸出者</label>
																<div class="col-md-9 input-group ">
																	<input type="text" name="applicantId" id="applicantId"
																		required class="form-control col-md-9" />

																</div>
															</div>
															<div class="form-group row">
																<label class="control-label col-md-2 ">使用者</label>
																<div class="col-md-9 input-group ">
																	<input type="text" name="rentalUserId"
																		id="rentalUserId" required
																		class="form-control col-md-9" />

																</div>
															</div>
															<div class="form-group row">
																<label class="control-label col-md-2 ">用途</label>
																<div class="col-md-9  input-group">
																	<input type="text" class="form-control col-md-9"
																		name="purpose" id="purpose" value="勤務">
																</div>
															</div>
															<div class="form-group row">
																<label class="control-label col-md-2  ">場所</label>
																<div class="col-md-9 input-group ">
																	<input type="text" id="storageLocation"
																		name="storageLocation" value="自社"
																		class="form-control col-md-9">
																</div>
															</div>
															<div class="form-group row">
																<label class="control-label col-md-2  ">特記事項</label>

																<div class="col-md-9 input-group ">
																	<input type="text" id="speciality" name="speciality"
																		class="form-control col-md-9">
																</div>
															</div>
															<div class="form-group row">
																<label class="control-label col-md-2 ">分類</label>
																<div class="col-md-9 input-group "
																	th:if="${kubunCode} != null">
																	<select class="form-control" id="singleSelect"
																		name="singleSelect" onchange="getSubItem()">
																		<option value="">選択</option>
																		<option th:each="productKindCode : ${kubun}"
																			th:value="${productKindCode.codeDetailId}"
																			th:text="${productKindCode.codeDetailName}"></option>
																	</select>

																</div>
																<p th:unless="${kubunCode} != null">データがありません</p>
															</div>
															<div class="form-group row">
																<label class="control-label col-md-2  ">種類</label>

																<div class="col-md-9 input-group ">

																	<select class="select2_multiple form-control"
																		id="sub_singleSelect" name="sub_singleSelect"
																		onchange="getSubSubItem()">

																		<option value="">選択</option>
																	</select>

																</div>

															</div>


															<div class="form-group row">
																<label class="control-label col-md-2 ">選択</label>
																<div class="col-md-9 input-group ">
																	<select class="select2_multiple form-control"
																		id="sub_subSelect" name="sub_subSelect">

																		<option value="">選択</option>


																	</select>
																</div>
															</div>
															<div class="form-group row">
																<label class="control-label col-md-2  ">BP社名</label>
																<div class="col-md-9 input-group ">
																	<input type="text" id="bpName" name="bpName"
																		class="form-control col-md-9">
																</div>
															</div>
															<div class="form-group row">


																<div class="col-md-12  ">

																	<input type="button" class="btn btn-success pull-right"
																		id="button1" onclick="writeItem();" value="追加" />

																</div>
															</div>
														</form>
													</div>
												</div>
											</div>


											<div class="x_panel">
												<div class="x_title">
													<h2>貸与目録</h2>
													<div class="clearfix"></div>
												</div>
												<div class="x_content">
													<div class="form-group row" style="text-align: center;">

														<table id="selectedAsset">
															<thead>
																<tr>

																	<th class="col-md-1" id="rentalUserId_insert">使用者</th>
																	<th class="col-md-1" id="applicantId_insert">貸出者</th>
																	<th class="col-md-1" id="item1_insert">種類</th>
																	<th class="col-md-1" id="assetNumber_insert">管理番号</th>
																	<th class="col-md-1" id="purpose_insert">用途</th>
																	<th class="col-md-1" id="storageLocation_insert">場所</th>
																	<th class="col-md-1" id="speciality_insert">特記事項</th>
																	<th class="col-md-1" id="bpName_insert">BP社名</th>
																	<th class="col-md-1" id="returnPeriod_insert">返却期間</th>
																	<th class="col-md-1" id="cancel_insert">取消</th>
																</tr>
															</thead>
															<tbody></tbody>
														</table>

													</div>
												</div>
											</div>

										</div>

										<div class="modal-footer">
											<input type="button" class="btn btn-primary pull-left"
												id="insertButton" value="貸与" onclick="rentalItem();" />
											<button type="button" class="btn btn-secondary"
												onclick="cancelInsert()">戻る</button>
										</div>
									</div>
								</div>
							</div>
							<!-- /insert modal -->

						</div>
					</div>
				</div>

			</div>
		</div>
		<!-- /page content -->

		<!-- footer content -->
		<div th:insert="/fragments/footer :: footer" th:remove="tag"></div>
		<!-- /footer content -->
	</div>


	<!-- jQuery -->
	<script src="../vendors/jquery/dist/jquery.min.js"></script>
	<!-- jquery-validation-1.19.1 -->
	<script
		src="../vendors/jquery-validation-1.19.1/dist/jquery.validate.min.js"></script>


	<!-- Bootstrap -->
	<script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>

	<!-- jquery-ui -->
	<script th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>
	<!-- DataTable -->
	<script th:src="@{/DataTables-1.10.20/js/jquery.dataTables.min.js}"></script>
	<script th:src="@{/DataTables-1.10.20/js/dataTables.bootstrap4.min.js}"></script>

	<!-- FastClick -->
	<script src="../vendors/fastclick/lib/fastclick.js"></script>
	<!-- NProgress -->
	<script src="../vendors/nprogress/nprogress.js"></script>
	<!-- iCheck -->
	<script src="../vendors/iCheck/icheck.min.js"></script>
	<!-- bootstrap-datetimepicker -->
	<script src="../vendors/moment/min/moment.min.js"></script>
	<script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
	<script
		src="../vendors/bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
	<!-- Custom Theme Scripts -->
	<script src="../build/js/custom.min.js"></script>

	<!-- page script -->
	<script th:inline="javascript">
    /*<![CDATA[*/




			/*validationの重なるエラーメッセージ  */
    		$.validator.messages.number = '有効な数字を入力';
    		$.validator.messages.maxlength = '{0} 文字以下を入力';

    	     var deleteList=new Array();
    	     var assetKey = new Map();




  var modalesectiondata = null;

    	var kubunCodeMap = new Map();
    	var kubunItemMap = new Map();
    	/*listで区分コードを呼び出す  */
		var kubunCode = /*[[${kubunCode}]]*/;
		/* keyはitem1でcodeDetailNameがvalueになるmapを作る */
		kubunCode.forEach(function( value ) {

			kubunCodeMap.set(value.item1,value.codeDetailName);

    	});
		/* keyはcodeDetailIdでcodeDetailNameがvalueになるmapを作る */
		kubunCode.forEach(function( value ) {

		kubunItemMap.set(value.codeDetailId, value.codeDetailName);});
    	var statusCodeMap = new Map();
    	/*listで状態コードを呼び出す  */
    	var statusCode = /*[[${statusCode}]]*/;
    	/* keyはcodeDetailIdでcodeDetailNameがvalueになるmapを作る */
    	statusCode.forEach(function( value ) {

    		statusCodeMap.set(value.codeDetailId, value.codeDetailName);
    	});

	function cancelInsert(){

		/*削除する前に確認する  */



			 var rental =new Object();
			 var tdArr = new Array();
			 var tr = $('#selectedAsset tbody tr');
			 var td =  $('#selectedAsset tbody tr td');
			 tr.each(function(i){

				var assetSeq=td.eq(8).text();

			  $.ajax({
					"url" : "/rental/cancelAsset",
				    "type" : "post",
			 		"dataType": "json",
					"data" : assetSeq,
					"contentType": "application/JSON",
					"Error" : function(){
    					alert("キャンセル不可能");
    				}
			   });
			  $(function() {

/* キャンセルが出来たら一行を消す */
				tr.remove();
			  })
			});
			 /*  */
			 $(function() {
				/*表示されるテキストの初期化*/
				  $('#rentalUserId').val("");
				  $('#bpName').val("");
				  $('#speciality').val("");
				  $('select').find('option:first').attr('selected', 'selected');
					$('#modal3d2').modal("hide");
				})






    }


        $(function(){




        	 $('#rentalsDay_search').datetimepicker({
                 format: 'YYYY-MM-DD'
             });

        	/*!カーレンダーの機能
        	*/
            $('#rentalDay_search').datetimepicker({
                format: 'YYYY-MM-DD'
            });
        	/*!カーレンダーの機能  */
            $('#myDatepicker').datetimepicker({
                format: 'YYYY-MM-DD'
            });
        	/*!カーレンダーの機能  */
            $('#returnPeriod_search').datetimepicker({
                format: 'YYYY-MM-DD'
            });

            /*二つ一つの日付を選べるカーレンダーのフォーマットを決める  */
        	$('#rental_search').daterangepicker({
				startDate: moment().add(-1, "months"),
				endDate: moment(),
			 locale: {
			       format: 'YYYY/MM/DD'
			   }, function(start, end, label) {
			       console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
			   }
			});
        	/*!貸与日で貸与情報を探す */
    		$('#rental_search').on('cancel.daterangepicker', function(ev, picker) {
				  //do something, like clearing an input
					$('#rental_search').val('');
				    var date = $("#rental_search").val();
				    modalesectiontable
				    .column(2)
				    .search(date)
				    .draw();
			});
        	/*カーレンダーで期間を無くして今貸与されてるものを全部見えることにする */
        	$('#rental_search').val('');
        	/*／!カーレンダーの機能  */
            var modalesectiontable = $("#table1").DataTable({

            	"language": {
            		"info":           "表示 _START_ ~ _END_ の _TOTAL_ エントリ",
            		"infoEmpty":      "表示 0 ~ 0 の 0 エントリ",
            	    "infoFiltered":   "",
            	    "emptyTable": "表にデータがない",
            	    "paginate": {
            	        "first":      "最初",
            	        "last":       "最後",
            	        "next":       "次へ",
            	        "previous":   "前の"
            	    }
                },
            	fixedHeader: true,
            	"processing": true,
            	"serverSide": true,
            	"start": 0,
                "length": 10,
                "searching": false,
                "paging": true,
                "lengthChange": false,
                "ordering": false,

                "ajax": {
                	url: /*[[@{/rental/getRentalList}]]*/ 'rental/getRentalList',
                	type: "POST",
                	dataType: "json",
                	contentType: 'application/JSON',
                	data: function ( d ) {
					/*二つの検索条件
					 *1.資産ナンバーで探す
					 *2.貸与日で探す
					 */
                		d.columns[0].search.value = $('#assetNumber_search').val();
                   		d.columns[1].search.value = $('#rental_search').val();
                   		d.columns[2].search.value = $('#rentalNo_search').val();
                        return JSON.stringify(d);
                    }
                },
                "Error" : function(){
					alert("初期化不可能");
				},
/*コンローラーで貰ったデータを元にしてデータを見せる  */
                "columnDefs": [

                	{ targets: 0, data: "rentalNo"},

                    { targets: 1, data: "assetNumber"},

                    { targets: 2, data: function ( d ) {
                    	return kubunItemMap.get(d.kubunCode);
                    }},

                    { targets: 3, data: "storageLocation"},

                    { targets: 4, data: "rentalUserId"},

                    { targets: 5, data: function ( d ) {
                    	var str = d.rentalDay;
                    	return str.substring(0, 4) + "-" + str.substring(4, 6) + "-" + str.substring(6, 8);
                    }},

                    { targets: 6, data: function ( d ) {
                    	var str = d.returnPeriod;
                    	return str.substring(0, 4) + "-" + str.substring(4, 6) + "-" + str.substring(6, 8);
                    }},
		/* 変更ボタン */
                    { targets: 7,
                    	data: "description_u",
                        render: function ( data, type, row, meta ) {

                          return '<button type="button" class="btn btn-warning" id="updateButton" onclick = "researchRental(' + row.assetSeq + ')" >変更</button>'
                          +'<button type="button" class="btn btn-danger" id="deleteButton" onclick = "deleteAsset(' + row.assetSeq + ')" >返却</button>';

                           }
                    }

                ]


            });

            /*assetNumberを貰ってメイン画面のデータを変える*/
            $('#assetNumber_search').on( 'keyup', function () {
            	$('#assetNumber_search').val(this.value.replace(new RegExp("'", 'g'), ''));
            	modalesectiontable
                .column(0)
                .search( this.value )
                .draw();
            } );
            /*rental_dayを貰ってメイン画面のデータを変える*/
            $("#rental_search").change(function () {
                var date = $("#rental_search").val();
                modalesectiontable
                .column(1)
                .search(date)
                .draw();
            });
            $("#rentalNo_search").on( 'keyup',function () {
            	$('#rentalNo_search').val(this.value.replace(new RegExp("'", 'g'), ''));

                modalesectiontable
                .column(2)
                .search(this.value)
                .draw();
            });

        })
    /*]]>*/
    </script>


	<script th:inline="javascript">
	/*<![CDATA[*/
/*データのupdateメソッド
引数はrentalのドメインを作ってajaxを利用する
戻り値も無し
*/



function updateRental(){
		 /* 最初に日付を貰うときの有効性検査  */
		 var datatimeRegexp = /[0-9]{4}-(0?[1-9]|1[012])-(0?[1-9]|[12][0-9]|3[01])/;
         var form = $('#updateForm');
         if ( !datatimeRegexp.test($('.date_check').val()) ) {
             alert("日付は yyyy-MM-dd 形式で入力してください.");
             return false;
         }
/* 貸与日と返却期間の差を計る */
         var startDate = $( "input[name='rentalDay']" ).val(); //2017-12-10
         var startDateArr = startDate.split('-');

         var endDate = $( "input[name='returnPeriod']" ).val(); //2017-12-09
         var endDateArr = endDate.split('-');

         var startDateCompare = new Date(startDateArr[0], parseInt(startDateArr[1])-1, startDateArr[2]);
         var endDateCompare = new Date(endDateArr[0], parseInt(endDateArr[1])-1, endDateArr[2]);

         if(startDateCompare.getTime() > endDateCompare.getTime()) {

             alert("貸与日と貸与期限を確認してください。");

             return false;
         }
         /* 計算した貸与日と返却期間の差がプラスであれば下の有個性検査を行う  */
         form.validate({
             rules: {
             	rentalUserId : {
             		required : true,
             		maxlength : 15
             	},

             	purpose : {
             		required : true,
             		maxlength : 15
             	},
             	speciality : {

             		maxlength : 20
            	},
             	storageLocation : {
             		required : true,
             		maxlength : 20
             	},
             	returnPeriod : {
             		required : true

             	},
             	rentalDay : {
             		required : true
             	},
             	applicantId : {
             		required : true,
             		maxlength : 15
             	},
             	bpName : {

             		maxlength : 15
             	}

             },
             messages: {

             	rentalUserId : {
             		required : "使用者を入力してください"
             	},
             	purpose : {
             		required : "用途を入力してください"
             	},
             	storageLocation : {
             		required : "場所を入力してください"
             	},
             	returnPeriod : {
             		required : "貸与期限を指定してください"
             	},
             	rentalDay : {
             		required : "貸与日を指定してください"
             	},
             	applicantId : {
             		required : "貸与者を指定してください"
             	}

             },

             /* カーレンダーの下にエラーを出力する  */
             errorPlacement: function(error, element) {
                 if (element.attr("name") == "returnPeriod") {
                   error.insertAfter("#returnPeriod_search");
                 }else if(element.attr("name") == "rentalDay") {
                   error.insertAfter("#rentalDay_search");
                 }

                 else {
                   error.insertAfter(element);
                 }
             }
         });


/* 有効性を通過したら下のメソッドを行う */
         if (form.valid()) {

     		/*変更してもらったデータにもし-の文字があればなくすメソッド  */
        	 String.prototype.replaceAll = function(org, dest) {
        		    return this.split(org).join(dest);
        		}

     		/* 変更する情報をオブジェクト化する  */
        	var rental = new Object();
        	rental.rentalNo=$('#rentalNo_view').val();
        	rental.assetNumber=$('#assetNumber_view').val();
        	rental.codeDetailName=$('#codeDetailName_view').val();
        	rental.purpose=$('#purpose_view').val();
        	rental.storageLocation=$('#storageLocation_view').val();
        	rental.rentalDay=$('#rentalDay_view').val().replaceAll("-","");
        	rental.speciality=$('#speciality_view').val();
        	rental.returnPeriod=$('#returnPeriod_view').val().replaceAll("-","");
        	rental.rentalUserId=$('#rentalUserId_view').val();
        	rental.bpName=$('#bpName_view').val();
        	rental.applicantId=$('#applicantId_view').val();
        	rental.assetSeq=$('#assetSeq_hidden').val();

            		$.ajax({
         			   type  : "POST",
         			   url : "/rental/updateRental",
         				dataType : "json",
         				"contentType" : "application/JSON",
         				data : JSON.stringify(rental),
        				success : function(data){

/* もしアップデートが良くできたら0以上の数字をもらえる  */

        if(data>0){
        	location.reload(true);
        }
        				},
        				"Error" : function(){
        					alert("変更不可能");
        				}
         	});


         }
/*変更してページをリロードする  */
	}

function researchRental(assetSeq){



	$.ajax({
		   type  : "POST",
		   url : "/rental/researchRental",
			dataType : "json",
			"contentType" : "application/JSON",
			data : JSON.stringify(assetSeq),
			success : function(data){

				var returnPeriod=data.returnPeriod;
				returnPeriod=returnPeriod.substring(0, 4) + "-" + returnPeriod.substring(4, 6) + "-" + returnPeriod.substring(6, 8);
				var	rentalDay=data.rentalDay;
				rentalDay=rentalDay.substring(0, 4) + "-" + rentalDay.substring(4, 6) + "-" + rentalDay.substring(6, 8);
			$('#rentalNo_view').val(data.rentalNo);
			$('#assetNumber_view').val(data.assetNumber);
			$('#codeDetailName_view').val(kubunItemMap.get(data.kubunCode));
			$('#purpose_view').val(data.purpose);
			$('#storageLocation_view').val(data.storageLocation);
			$('#rentalDay_view').val(rentalDay);
			$('#speciality_view').val(data.speciality);
			$('#returnPeriod_view').val(returnPeriod);
			$('#rentalUserId_view').val(data.rentalUserId);
			$('#applicantId_view').val(data.applicantId);
			$('#assetSeq_hidden').val(data.assetSeq);

			}

});

/* モーダルを閉じるボタン以外では閉じれない  */
	$('#modal3d').modal({    backdrop: 'static', keyboard: false});

}

/* 返却ボタンを押すと確認して返却を行う */
	function deleteAsset(assetSeq){

		 var result = confirm('返却しますか？');
		 /*もしyesであれば選択した行のデータを元にして貸与テーブルのデータを削除する  */
		 if(result) {
				$.ajax({
					   type  : "POST",
					   url : "/rental/returnAsset",
						dataType : "json",
						"contentType" : "application/JSON",
						data : JSON.stringify(assetSeq),
						"Error" : function(){
	    					alert("返却不可能");
	    				}


			});
				location.reload(true);

		 } else {


		 }





		}
	/* モーダルボタンをクリックしてインサートする画面を開く  */
		function modalInsert() {
		    var user = /*[[${session.id}]]*/ 'user';
			if(user==null){alert("ログインしてください");
			/* モーダルを閉じるボタン以外では閉じれない  */
    		}else{$('#modal3d2').modal({    backdrop: 'static', keyboard: false});

    		}
    	}

		function getSubItem() {
			/* 最初の選択地で選択してもらったデータを元にして次の選択地をセッティングする  */
			var kub =/*[[${kubunCode}]]*/;


			$('#singleSelect').click(
					/* 二番目のボタンが押されたら下のメソッドが行われる  */
					function() {
						/* まだ何も選択してなければ下のメソッドは実行されない
						* 当てはまるデータがあれば選択地にセティングする
						*/
						if($('#singleSelect option:selected').val()!=""){
						var item=$('#singleSelect option:selected').val();

							var html = '<option value="">選択</option>';
							kub.forEach(function(value) {
							if(value.item1==item){


								html += '<option value="' +value.codeDetailId + '">'
										+ value.codeDetailName + '</option>';

							}});
							$('#sub_singleSelect').html(html);
						}
						});
		}


		function getSubSubItem() {


			/* 三番目のボタンが押されたら下のメソッドが行われる  */
			$('#sub_singleSelect').click(
					function() {
						/* まだ何も選択してなければ下のメソッドは実行されない
						* 当てはまるデータがあれば選択地にセティングする
						*/
		if($('#sub_singleSelect option:selected').val()!=""){
					var selectedItem = $('#sub_singleSelect option:selected').val();
					selectedItem=selectedItem.replace(/[^0-9]/g,'');
					/*ajaxを使って実際に使えるものかを確認する  */
					$.ajax({
	   			"url" : "/rental/getAssetList",
	    		"type" : "post",
	   	 		"dataType": "json",
	   	 		"contentType": "application/JSON",
	   			"data" : selectedItem,
	   			contentType: 'application/JSON',
	   		 	"success" : function(data){

	   			var itemName=$('#sub_subSelect').val();
				var html = '<option value="">選択</option>';

				data.forEach(function(value) {
					if (!assetKey.has(value.assetSeq)){
					html += '<option value="' + value.assetSeq + '">'
							+ value.assetNumber + '</option>';

					}
				});
				$('#sub_subSelect').html(html);
			},
			"Error" : function(value){
				alert("貸与不可能");
			}


	});
					   }
					}
);


		}

/* 任意でリスト化した貸与情報の中で一行だけ削除するメソッド */
 function deleteRow(btn) {

		var assetSeq=btn.value;
		alert(assetSeq);
	 assetKey.delete(Number(assetSeq));

		/* もし貸与から保管に変更できたら一行を消す  */
		var row = btn.parentNode.parentNode;
		 row.parentNode.removeChild(row);

	alert(JSON.stringify(assetKey));
}

 String.prototype.replaceAll = function(org, dest) {
	    return this.split(org).join(dest);
	}

 function rentalItem() {

		var tdArr = new Array();
		/* テーブルにある貸与情報を全て持ち込んでリスト化する */
		$('#selectedAsset tbody tr').each(function() {
			var rental =new Object();
			var cellText = $(this);
			rental.rentalUserId =cellText.find("#rentalUserId_i").text();
			rental.assetNumber =cellText.find("#assetNumber_i").text();
			rental.purpose  =cellText.find("#purpose_i").text();
			rental.storageLocation =cellText.find("#storageLocation_i").text();
			rental.speciality =cellText.find("#speciality_i").text();
			rental.returnPeriod =cellText.find("#returnPeriod_i").text().replaceAll("-","");
			rental.assetSeq=cellText.find("#assetSeq_i").text();
			rental.applicantId =cellText.find("#applicantId_i").text();
			rental.rentalDay=$('#todayDate').val().replaceAll("-","");
			rental.bpName=cellText.find("#bpName_i").text();
			rental.insertId = /*[[${session.id}]]*/ 'user';
			rental.updateId = /*[[${session.id}]]*/ 'user';
			tdArr.push(rental);



		});


	/* リスト化された貸与情報をデータテーブルに書き込む  */
	$.ajax({
		"url" : "/rental/addRental",
		"type" : "post",
		"dataType": "json",
		"contentType": "application/JSON",
		"data" : JSON.stringify(tdArr),
		"success" : function(d){ assetKey.clear();},
		"Error" : function(d){
			alert("貸与不可能");
		}

});
	/* もし 一行もなければ警告する一行以上だったらページをリロードする*/
	 if($('#selectedAsset tbody tr').length!=0){
			location.reload(true);

		 }else{
			alert("貸与する物がないです。");
		}

 }



	function writeItem() {

			/* 有効性の検査を行う  */
        	 var datatimeRegexp = /[0-9]{4}-(0?[1-9]|1[012])-(0?[1-9]|[12][0-9]|3[01])/;
            var form = $('#insertForm');
            if ( !datatimeRegexp.test($("#returnPeriod").val()) ) {
                alert("日付は yyyy-mm-dd 形式で入力してください.");
                return false;
            }

            var startDate =$("#todayDate").val(); //2017-12-10
            var startDateArr = startDate.split('-');

            var endDate = $("#returnPeriod").val(); //2017-12-09
            var endDateArr = endDate.split('-');

            var startDateCompare = new Date(startDateArr[0], parseInt(startDateArr[1])-1, startDateArr[2]);
            var endDateCompare = new Date(endDateArr[0], parseInt(endDateArr[1])-1, endDateArr[2]);

            if(startDateCompare.getTime() > endDateCompare.getTime()) {

                alert("貸与日と貸与期限を確認してください。");

                return false;
            }
            form.validate({
                rules: {
                	rentalUserId : {
                		required : true,
                 		maxlength : 15
                	},
                	purpose : {
                		required : true,
                 		maxlength : 15
                	},
                 	speciality : {

                 		maxlength : 20
                	},
                	storageLocation : {
                		required : true,
                 		maxlength : 20
                	},
                	returnPeriod : {
                		required : true
                	},
                	rentalDay : {
                		required : true
                	},
                	applicantId : {
                		required : true,
                 		maxlength : 15
                	},
                 	bpName : {

                 		maxlength : 15
                 	}

                },
                messages: {
                	rentalUserId : {
                		required : "使用者を入力してください"
                	},
                	purpose : {
                		required : "用途を入力してください"
                	},
                	storageLocation : {
                		required : "場所を入力してください"
                	},
                	returnPeriod : {
                		required : "貸与期限を指定してください"
                	},
                	rentalDay : {
                		required : "貸与日を指定してください"
                	},
                	applicantId : {
                		required : "貸与者を指定してください"
                	}

                },
                errorPlacement: function(error, element) {
                    if (element.attr("name") == "returnPeriod") {
                      error.insertAfter("#myDatepicker");
                    } else {
                      error.insertAfter(element);
                    }
                }
            });



            if (form.valid()) {

            	var number=$("#sub_subSelect option:selected").text();
				/* もう一回資産の情報を確認してデータを表示する */
    			$.ajax({
    			   			"url" : "/rental/getAsset",
    			    		"type" : "post",
    			   	 		"dataType": "json",
    			   			"data" : number,
    			   			"contentType": "application/JSON",
    			   		 	"success" : function(data){

    			   		 	$('#selectedAsset tbody').append('<tr style="text-align:center;"><td id="rentalUserId_i">'
    			   					+$('#rentalUserId').val()+
    			   					'</td><td id="applicantId_i">'
    			   					+$("#applicantId").val()+
    			   					'</td><td>'
    			   				+$("#sub_singleSelect option:selected").text()+
    			   					'</td><td id="assetNumber_i">'
    			   				+number+
    			   					'</td><td id="purpose_i">'
    			   					+$("#purpose").val()+
    			   					'</td><td id="storageLocation_i">'
    			   					+$("#storageLocation").val()+
    			   					'</td><td id="speciality_i">'
    			   					+$("#speciality").val()+
    			   					'</td><td id="bpName_i">'
    			   					+$("#bpName").val()+
    			   					'</td><td id="assetSeq_i" style="display:none;"> '
    				   				+data.assetSeq+
    				   				'</td><td id="returnPeriod_i">'
    				   					+$("#returnPeriod").val()+

    			   					'</td><td><button value="'+data.assetSeq+'" class="btn btn-warning" id="cancelitem" onclick="deleteRow(this)">削除</button></td></tr>');
    			   		 	alert(data.assetSeq);
    			   		 assetKey.set(data.assetSeq,data.assetNumber);
    			   			$(function(){  $('select').find('option:first').attr('selected', 'selected');})
    			    },
    				"Error" : function(){
    					alert("貸与不可能");
    				}
    			});



            }

	}
		/*]]>*/
	</script>

</body>
</html>